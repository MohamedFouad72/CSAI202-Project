@page
@model StoreInventoryApp.Pages.Purchases.CreateModel
@{
    ViewData["Title"] = "Create Purchase Order";
}

<div class="container mt-4">
    <h2>Create Purchase Order</h2>
    <p class="text-muted">Add products from suppliers to update inventory</p>
    <hr />

    @if (!ModelState.IsValid)
    {
        <div class="alert alert-danger">
            <ul class="mb-0">
                @foreach (var error in ModelState.Values.SelectMany(v => v.Errors))
                {
                    <li>@error.ErrorMessage</li>
                }
            </ul>
        </div>
    }

    <form method="post" id="purchaseForm">
        <div class="row">
            <!-- Left Column: Purchase Information -->
            <div class="col-md-6">
                <div class="card mb-3">
                    <div class="card-body">
                        <h5 class="card-title">Purchase Information</h5>

                        <div class="mb-3">
                            <label for="supplierSelect" class="form-label">Supplier *</label>
                            <select id="supplierSelect" name="SupplierID" class="form-select" required>
                                <option value="">-- Select Supplier --</option>
                                @foreach (var supplier in Model.Suppliers)
                                {
                                    <option value="@supplier.SupplierID">@supplier.SupplierName</option>
                                }
                            </select>
                        </div>

                        <div class="mb-3">
                            <label for="storeSelect" class="form-label">Destination Store *</label>
                            <select id="storeSelect" name="StoreID" class="form-select" required>
                                <option value="">-- Select Store --</option>
                                @foreach (var store in Model.Stores)
                                {
                                    <option value="@store.StoreID">@store.StoreName</option>
                                }
                            </select>
                        </div>

                        <div class="mb-3">
                            <label for="paymentMethod" class="form-label">Payment Method</label>
                            <select id="paymentMethod" name="PaymentMethod" class="form-select">
                                <option value="Cash">Cash</option>
                                <option value="Credit">Credit</option>
                                <option value="Bank Transfer">Bank Transfer</option>
                                <option value="Check">Check</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Right Column: Add Products -->
            <div class="col-md-6">
                <div class="card mb-3">
                    <div class="card-body">
                        <h5 class="card-title">Add Product to Purchase</h5>

                        <div class="mb-3">
                            <label for="productSelect" class="form-label">Product</label>
                            <select id="productSelect" class="form-select">
                                <option value="">-- Select Product --</option>
                                @foreach (var product in Model.Products)
                                {
                                    <option value="@product.ProductID"
                                            data-name="@product.ProductName"
                                            data-cost="@product.UnitCost">
                                        @product.ProductName - $@product.UnitCost.ToString("F2")
                                    </option>
                                }
                            </select>
                        </div>

                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="quantity" class="form-label">Quantity</label>
                                    <input type="number" id="quantity" class="form-control" min="1" value="1" />
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="unitCost" class="form-label">Unit Cost ($)</label>
                                    <input type="number" id="unitCost" class="form-control" step="0.01" min="0" value="0" />
                                </div>
                            </div>
                        </div>

                        <button type="button" class="btn btn-success w-100" onclick="addProduct()">
                            <i class="bi bi-plus-circle"></i> Add to Purchase
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Purchase Items Table -->
        <div class="card mb-3">
            <div class="card-body">
                <h5 class="card-title">Purchase Items</h5>
                <div class="table-responsive">
                    <table class="table table-striped">
                        <thead>
                            <tr>
                                <th>Product</th>
                                <th>Quantity</th>
                                <th>Unit Cost</th>
                                <th>Subtotal</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody id="itemsBody">
                            <tr id="emptyRow">
                                <td colspan="5" class="text-center text-muted">No items added yet. Add products above to create purchase order.</td>
                            </tr>
                        </tbody>
                        <tfoot>
                            <tr class="table-info">
                                <th colspan="3" class="text-end">Total Amount:</th>
                                <th id="totalAmount">$0.00</th>
                                <th></th>
                            </tr>
                        </tfoot>
                    </table>
                </div>
            </div>
        </div>

        <!-- Hidden field to store purchase items as JSON -->
        <input type="hidden" name="PurchaseItemsJson" id="purchaseItemsJson" />

        <!-- Action Buttons -->
        <div class="d-flex justify-content-between">
            <a asp-page="/Inventory/Index" class="btn btn-secondary">
                <i class="bi bi-x-circle"></i> Cancel
            </a>
            <button type="submit" class="btn btn-primary" id="submitBtn" disabled>
                <i class="bi bi-save"></i> Create Purchase Order
            </button>
        </div>
    </form>
</div>

@section Scripts {
    <script>
        // Array to store purchase items
        let purchaseItems = [];

        // Auto-fill unit cost when product is selected
        document.getElementById('productSelect').addEventListener('change', function() {
            const selectedOption = this.options[this.selectedIndex];
            if (selectedOption.value) {
                document.getElementById('unitCost').value = selectedOption.getAttribute('data-cost');
            }
        });

        // Add product to purchase cart
        function addProduct() {
            const productSelect = document.getElementById('productSelect');
            const productId = productSelect.value;
            const productName = productSelect.options[productSelect.selectedIndex].getAttribute('data-name');
            const quantity = parseInt(document.getElementById('quantity').value);
            const unitCost = parseFloat(document.getElementById('unitCost').value);

            // Validation
            if (!productId) {
                alert('Please select a product');
                return;
            }

            if (quantity <= 0 || isNaN(quantity)) {
                alert('Quantity must be greater than 0');
                return;
            }

            if (unitCost <= 0 || isNaN(unitCost)) {
                alert('Unit cost must be greater than 0');
                return;
            }

            // Check if product already exists in cart
            const existingIndex = purchaseItems.findIndex(item => item.productId === productId);
            if (existingIndex >= 0) {
                // Update existing item quantity
                purchaseItems[existingIndex].quantity += quantity;
            } else {
                // Add new item
                purchaseItems.push({
                    productId: productId,
                    productName: productName,
                    quantity: quantity,
                    unitCost: unitCost
                });
            }

            // Update the table
            updateTable();

            // Reset form fields
            productSelect.value = '';
            document.getElementById('quantity').value = '1';
            document.getElementById('unitCost').value = '0';
        }

        // Remove product from cart
        function removeProduct(index) {
            purchaseItems.splice(index, 1);
            updateTable();
        }

        // Update the items table
        function updateTable() {
            const tbody = document.getElementById('itemsBody');
            tbody.innerHTML = '';

            if (purchaseItems.length === 0) {
                // Show empty message
                tbody.innerHTML = '<tr id="emptyRow"><td colspan="5" class="text-center text-muted">No items added yet. Add products above to create purchase order.</td></tr>';
                document.getElementById('submitBtn').disabled = true;
            } else {
                // Calculate total and display items
                let total = 0;
                purchaseItems.forEach((item, index) => {
                    const subtotal = item.quantity * item.unitCost;
                    total += subtotal;

                    const row = `
                        <tr>
                            <td>${item.productName}</td>
                            <td>${item.quantity}</td>
                            <td>$${item.unitCost.toFixed(2)}</td>
                            <td>$${subtotal.toFixed(2)}</td>
                            <td>
                                <button type="button" class="btn btn-sm btn-danger" onclick="removeProduct(${index})">
                                    <i class="bi bi-trash"></i> Remove
                                </button>
                            </td>
                        </tr>
                    `;
                    tbody.innerHTML += row;
                });

                // Update total amount
                document.getElementById('totalAmount').textContent = '$' + total.toFixed(2);

                // Enable submit button
                document.getElementById('submitBtn').disabled = false;
            }

            // Update hidden field with JSON data
            document.getElementById('purchaseItemsJson').value = JSON.stringify(purchaseItems);
        }

        // Prevent form submission if no items
        document.getElementById('purchaseForm').addEventListener('submit', function(e) {
            if (purchaseItems.length === 0) {
                e.preventDefault();
                alert('Please add at least one item to the purchase order');
            }
        });
    </script>
}
