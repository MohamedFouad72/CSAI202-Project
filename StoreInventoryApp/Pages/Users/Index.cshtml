@page
@model StoreInventoryApp.Pages.Users.IndexModel
@using System.Data
@{
    ViewData["Title"] = "Manage Users";
}

<div class="d-flex justify-content-between align-items-center mb-4">
    <div>
        <h2 class="fw-bold">User Management</h2>
        <p class="text-muted">View and manage system users and permissions.</p>
    </div>
    <div>
        <a asp-page="/Users/Create" class="btn btn-primary">
            <i class="bi bi-person-plus-fill me-2"></i> Add New User
        </a>
    </div>
</div>

@if (TempData["Success"] != null)
{
    <div class="alert alert-success alert-dismissible fade show" role="alert">
        <i class="bi bi-check-circle-fill me-2"></i>
        @TempData["Success"]
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>
}

@if (TempData["Error"] != null)
{
    <div class="alert alert-danger alert-dismissible fade show" role="alert">
        <i class="bi bi-exclamation-triangle-fill me-2"></i>
        @TempData["Error"]
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>
}

<div class="card shadow-sm">
    <div class="card-body p-0">
        <div class="table-responsive">
            <table class="table table-hover align-middle mb-0">
                <thead class="bg-light">
                    <tr>
                        <th class="ps-4">User</th>
                        <th>Role</th>
                        <th>Store</th>
                        <th>Position</th>
                        <th>Contact</th>
                        <th>Joined</th>
                        <th>Status</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (DataRow row in Model.UsersList.Rows)
                    {
                        bool isActive = Convert.ToBoolean(row["IsActive"]);
                        string statusClass = isActive ? "bg-success" : "bg-secondary";
                        string statusText = isActive ? "Active" : "Inactive";
                        
                        <tr>
                            <td class="ps-4">
                                <div class="d-flex align-items-center">
                                    <div class="bg-light rounded-circle p-2 me-3">
                                        <i class="bi bi-person-fill text-primary"></i>
                                    </div>
                                    <div>
                                        <div class="fw-bold">@row["UserName"]</div>
                                        <small class="text-muted">ID: @row["UserID"]</small>
                                    </div>
                                </div>
                            </td>
                            <td>
                                <span class="badge bg-info">@row["UserRole"]</span>
                            </td>
                            <td>
                                @(row["StoreName"] == DBNull.Value ? "N/A" : row["StoreName"])
                            </td>
                            <td>
                                @(row["Position"] == DBNull.Value ? "-" : row["Position"])
                            </td>
                            <td>
                                <div class="small">
                                    <div>@(row["UserEmail"] == DBNull.Value ? "-" : row["UserEmail"])</div>
                                    <div class="text-muted">@(row["UserPhone"] == DBNull.Value ? "-" : row["UserPhone"])</div>
                                </div>
                            </td>
                            <td>
                                <div class="small">
                                    @Convert.ToDateTime(row["CreatedAt"]).ToString("MMM dd, yyyy")
                                    @if (row["HireDate"] != DBNull.Value)
                                    {
                                        <div class="text-muted">Hired: @Convert.ToDateTime(row["HireDate"]).ToString("MMM yyyy")</div>
                                    }
                                </div>
                            </td>
                            <td>
                                <span class="badge @statusClass">@statusText</span>
                            </td>
                            <td>
                                <div class="btn-group btn-group-sm">
                                    <a asp-page="/Users/Edit" asp-route-id="@row["UserID"]" class="btn btn-outline-primary">
                                        <i class="bi bi-pencil"></i> Edit
                                    </a>
                                    
                                    @if (Model.CurrentUserRole == "Admin" || Model.CurrentUserRole == "Manager")
                                    {
                                        <form method="post" asp-page-handler="ToggleStatus" class="d-inline">
                                            <input type="hidden" name="userId" value="@row["UserID"]" />
                                            <button type="submit" class="btn btn-outline-warning">
                                                <i class="bi bi-power"></i> @(isActive ? "Deactivate" : "Activate")
                                            </button>
                                        </form>
                                    }
                                    
                                    @if (Model.CurrentUserRole == "Admin")
                                    {
                                        <form method="post" asp-page-handler="Delete" class="d-inline" 
                                              onsubmit="return confirm('Are you sure you want to delete this user?');">
                                            <input type="hidden" name="userId" value="@row["UserID"]" />
                                            <button type="submit" class="btn btn-outline-danger">
                                                <i class="bi bi-trash"></i> Delete
                                            </button>
                                        </form>
                                    }
                                </div>
                            </td>
                        </tr>
                    }
                    
                    @if (Model.UsersList.Rows.Count == 0)
                    {
                        <tr>
                            <td colspan="8" class="text-center py-4">
                                <i class="bi bi-people display-4 text-muted d-block mb-2"></i>
                                <h5 class="text-muted">No users found</h5>
                                <p class="text-muted">Start by adding a new user</p>
                                <a asp-page="/Users/Create" class="btn btn-primary">
                                    <i class="bi bi-person-plus-fill me-2"></i> Add First User
                                </a>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    </div>
</div>

<style>
    .table th {
        font-weight: 600;
        text-transform: uppercase;
        font-size: 0.85rem;
        letter-spacing: 0.5px;
    }
    
    .btn-group .btn {
        border-radius: 0.25rem !important;
        margin-right: 0.25rem;
    }
    
    .btn-group .btn:last-child {
        margin-right: 0;
    }
</style>